<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LotLocate PH</title>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css'
        rel='stylesheet' />
</head>

<body>
    <header class="app-header">
        <h1>LotLocate PH</h1>
    </header>
    <div class="disclaimer" id="disclaimerBar">
        <strong>Disclaimer:</strong> The output of this application is for viewing and preliminary assessment purposes
        only and cannot be used for legal purposes.
        It is advised to seek assistance from a duly licensed Geodetic Engineer or verify results from the mandated
        government agencies (e.g., LMB, LRA, DENR).
        The accuracy of the output is dependent on the accuracy of the input data and the selected reference point.
        <span class="disclaimer-close" id="closeDisclaimerBtn" title="Close Disclaimer">Ã—</span>
    </div>

    <div class="app-main-container">
        <aside class="sidebar">
            <div class="message-area" id="formMessages">
                {% if csv_error_message %}<div class="message error">{{ csv_error_message }}</div>{% endif %}
            </div>

            <section class="sidebar-section global-settings">
                <h2>Global Settings</h2>
                <form id="globalSettingsForm" onsubmit="return false;">
                    <div class="input-group">
                        <label for="target_crs_select">Coordinate Reference System (CRS):</label>
                        <select name="target_crs_select" id="target_crs_select" class="crs-select">
                            <option value="25391">PRS92 / Philippines Zone I (EPSG:25391)</option>
                            <option value="25392">PRS92 / Philippines Zone II (EPSG:25392)</option>
                            <option value="25393" selected>PRS92 / Philippines Zone III (EPSG:25393)</option>
                            <option value="25394">PRS92 / Philippines Zone IV (EPSG:25394)</option>
                            <option value="25395">PRS92 / Philippines Zone V (EPSG:25395)</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="reference_point_select">Reference Point (match CRS Zone):</label>
                        <select name="reference_point_select" id="reference_point_select" style="width: 100%;" required>
                            {% if reference_points_data %}<option value=""></option>
                            {% for point in reference_points_data %}
                            <option value="{{ point.display_name }}" {% if selected_ref_point_name==point.display_name
                                %}selected{% endif %}>{{ point.display_name }}</option>
                            {% endfor %}
                            {% else %}<option value="" disabled selected>Error loading points</option>{% endif %}
                        </select>
                        <small>Ensure point's coordinates are for selected CRS.</small>
                    </div>

                    <h3 class="settings-subsection-header">Map Display Options</h3>
                    <div class="input-group checkbox-group">
                        <label for="toggleTieLines">
                            <input type="checkbox" id="toggleTieLines" name="toggleTieLines" checked>
                            Show Tie-Lines
                        </label>
                    </div>
                    <div class="input-group checkbox-group">
                        <label for="togglePobMarkers">
                            <input type="checkbox" id="togglePobMarkers" name="togglePobMarkers" checked>
                            Show POB Markers
                        </label>
                    </div>
                    <div class="input-group checkbox-group">
                        <label for="toggleParcelVertices">
                            <input type="checkbox" id="toggleParcelVertices" name="toggleParcelVertices" checked>
                            Show Parcel Vertices
                        </label>
                    </div>

                    <div class="input-group">
                        <label for="basemapSelect">Basemap:</label>
                        <select name="basemapSelect" id="basemapSelect" class="crs-select"> <!-- Re-use crs-select class for similar styling if appropriate -->
                            <option value="esriImagery">Esri World Imagery (Default)</option>
                            <option value="osmStandard">OpenStreetMap</option>
                            <option value="esriStreet">Esri World Street Map</option>
                        </select>
                    </div>
                </form>
            </section>

            <section class="sidebar-section lot-navigator">
                <h2>Survey Lots</h2>
                <ul id="lotList"></ul>
                <button type="button" id="addLotBtnSidebar" class="btn btn-success btn-block">+ Add New Lot</button>
                <button type="button" id="clearAllLotsBtn" class="btn btn-danger btn-block">Clear All Lots</button>
            </section>

            <section class="sidebar-section survey-management">
                <h2>Survey Management</h2>
                <div id="activeSaveStatusContainer" style="padding: 5px 10px; background-color: #e9ecef; margin-bottom: 10px; border-radius: 4px; text-align: center; border: 1px solid #ced4da;">
                    <span style="font-weight: bold; font-size: 0.8rem; color: #495057;">Current Save:</span> <span id="activeSaveNameDisplay" style="font-size: 0.8rem; color: #007bff; font-weight:500;">Default Survey</span>
                </div>
                <div class="input-group">
                    <button type="button" id="saveSurveyBtn" class="btn btn-primary btn-block">Save Current Survey</button>
                </div>
                <div class="input-group">
                    <button type="button" id="saveAsSurveyBtn" class="btn btn-info btn-block">Save As...</button>
                </div>
                <div class="input-group">
                    <label for="savedSurveysDropdown">Load a saved survey:</label>
                    <select id="savedSurveysDropdown" class="crs-select">
                        <option value="" disabled selected>Select a survey...</option>
                    </select>
                </div>
                <div class="input-group">
                    <button type="button" id="loadSelectedSurveyBtn" class="btn btn-success btn-block" disabled>Load Selected Survey</button>
                </div>
                <div class="input-group">
                    <button type="button" id="deleteSelectedSurveyBtn" class="btn btn-warning btn-block" disabled>Delete Selected Survey</button>
                </div>
                <div class="input-group">
                    <button type="button" id="exportSurveyDataBtn" class="btn btn-info btn-block">Export Survey Data (.llph)</button>
                </div>
                <div class="input-group">
                    <input type="file" id="importSurveyFile" accept=".llph,.json" style="display: none;">
                    <button type="button" id="importSurveyDataBtn" class="btn btn-success btn-block">Import Survey Data</button>
                </div>
                <div style="margin-top: 20px; padding-top: 10px; border-top: 1px solid #ccc;">
                    <button id="resetApplicationDataBtn" class="btn btn-danger btn-block">Reset All Application Data</button>
                </div>
            </section>

            <section class="sidebar-section export-buttons-section">
                <h3>Export Options</h3>
                <button type="button" id="exportShapefileBtn" class="btn btn-export">Export Shapefiles (.zip)</button>
                <button type="button" id="exportKmzBtn" class="btn btn-export">Export KMZ (.kmz)</button>
                <button type="button" id="exportDxfBtn" class="btn btn-export">Export DXF (.dxf)</button> <!-- NEW -->
                <button type="button" id="exportGeoJsonBtn" class="btn btn-export">Export GeoJSON (.geojson)</button>
                <!-- NEW -->
            </section>
        </aside>

        <main class="main-content-area">
            <section id="activeLotEditorArea" class="active-lot-editor-container placeholder">
                Select a lot from the list or add a new one to start editing.
            </section>

            <section class="map-container">
                <div id="map"></div>
            </section>
        </main>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js'></script>
    <script>
        const allReferencePointsData = JSON.parse({{ reference_points_data_json|tojson|safe }});
    </script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <p id="loadingMessage">Processing...</p>
    </div>
</body>

</html>